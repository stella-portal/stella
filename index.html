<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stella - Dealer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); }
        .status-pending { background: #f3f4f6; color: #374151; }
        .status-production { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-shipped { background: #dbeafe; color: #1e40af; }
        .item-reserved { background: #dbeafe; color: #1e40af; }
        .item-toproduce { background: #fef3c7; color: #92400e; }
        .item-shipped { background: #d1fae5; color: #065f46; }
        .progress-bar { background: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #3b82f6, #10b981); height: 100%; transition: width 0.3s; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1e40af; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
                <div class="text-6xl mb-4">üìä</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Loading...</h2>
                <p class="text-gray-500">Connecting to database...</p>
            </div>
        </div>
    </div>
    
    <script>
const CONFIG = {
    SPREADSHEET_ID: '1kQcSiTcmPu1dfbBH9wVEOeYOpgSXlfzbeur8u32373k',
    API_KEY: 'AIzaSyBaJW2t64e9TI3_Xw8-fgo9iB-o37WrBDM',
    SHEETS: { ORDERS: 'Orders', ORDER_ITEMS: 'Order Items', DEALERS: 'Dealers', SHIPMENTS: 'Shipments' }
};

const T = {
    en: { welcome:"Stella Dealer Portal", login:"Login", dealerCode:"Dealer Code", password:"Password", myOrders:"My Orders", logout:"Logout", orderNo:"Order #", date:"Order Date", status:"Status", ready:"Ready Date", shipped:"Ship Date", total:"Total", progress:"Progress", details:"Details", noOrders:"No orders found", pending:"In Queue", production:"In Production", readyStatus:"Ready", shippedStatus:"Shipped", back:"Back", manager:"Manager", prepaid:"Prepaid", balance:"Balance", plan:"Plan", fact:"Actual", error:"Invalid credentials", daysInProd:"Days", items:"Order Items", product:"Product", qty:"Qty", itemStatus:"Status", reserved:"Reserved", toProduce:"To Produce", shipments:"Shipment History", noShipments:"No shipments found", totalShipped:"Total Shipped" },
    de: { welcome:"Stella H√§ndlerportal", login:"Anmelden", dealerCode:"H√§ndlercode", password:"Passwort", myOrders:"Bestellungen", logout:"Abmelden", orderNo:"Best.Nr.", date:"Bestelldatum", status:"Status", ready:"Fertigstellung", shipped:"Versand", total:"Gesamt", progress:"Fortschritt", details:"Details", noOrders:"Keine Bestellungen", pending:"In Warteschlange", production:"In Produktion", readyStatus:"Fertig", shippedStatus:"Versendet", back:"Zur√ºck", manager:"Manager", prepaid:"Vorauszahlung", balance:"Restbetrag", plan:"Plan", fact:"Ist", error:"Ung√ºltige Daten", daysInProd:"Tage", items:"Bestellpositionen", product:"Produkt", qty:"Menge", itemStatus:"Status", reserved:"Reserviert", toProduce:"Zu produzieren", shipments:"Lieferverlauf", noShipments:"Keine Lieferungen", totalShipped:"Gesamt geliefert" },
    it: { welcome:"Portale Stella", login:"Accedi", dealerCode:"Codice", password:"Password", myOrders:"Ordini", logout:"Esci", orderNo:"Ordine", date:"Data", status:"Stato", ready:"Data pronto", shipped:"Spedizione", total:"Totale", progress:"Avanzamento", details:"Dettagli", noOrders:"Nessun ordine", pending:"In coda", production:"In produzione", readyStatus:"Pronto", shippedStatus:"Spedito", back:"Indietro", manager:"Manager", prepaid:"Prepagato", balance:"Saldo", plan:"Piano", fact:"Effettivo", error:"Credenziali errate", daysInProd:"Giorni", items:"Articoli", product:"Prodotto", qty:"Qt√†", itemStatus:"Stato", reserved:"Riservato", toProduce:"Da produrre", shipments:"Storico Spedizioni", noShipments:"Nessuna spedizione", totalShipped:"Totale spedito" },
    tr: { welcome:"Stella Bayi Portalƒ±", login:"Giri≈ü", dealerCode:"Bayi Kodu", password:"≈ûifre", myOrders:"Sipari≈ülerim", logout:"√áƒ±kƒ±≈ü", orderNo:"Sipari≈ü No", date:"Tarih", status:"Durum", ready:"Hazƒ±r Tarihi", shipped:"Sevk Tarihi", total:"Toplam", progress:"ƒ∞lerleme", details:"Detay", noOrders:"Sipari≈ü yok", pending:"Sƒ±rada", production:"√úretimde", readyStatus:"Hazƒ±r", shippedStatus:"Sevk Edildi", back:"Geri", manager:"Y√∂netici", prepaid:"√ñn √ñdeme", balance:"Bakiye", plan:"Plan", fact:"Ger√ßekle≈üen", error:"Ge√ßersiz giri≈ü", daysInProd:"G√ºn", items:"Sipari≈ü Kalemleri", product:"√úr√ºn", qty:"Adet", itemStatus:"Durum", reserved:"Rezerve", toProduce:"√úretilecek", shipments:"Sevkiyat Ge√ßmi≈üi", noShipments:"Sevkiyat yok", totalShipped:"Toplam sevk" },
    el: { welcome:"Œ†œçŒªŒ∑ Stella", login:"Œ£œçŒΩŒ¥ŒµœÉŒ∑", dealerCode:"ŒöœâŒ¥ŒπŒ∫œåœÇ", password:"ŒöœâŒ¥ŒπŒ∫œåœÇ", myOrders:"Œ†Œ±œÅŒ±Œ≥Œ≥ŒµŒªŒØŒµœÇ", logout:"ŒàŒæŒøŒ¥ŒøœÇ", orderNo:"ŒëœÅ.", date:"ŒóŒº/ŒΩŒØŒ±", status:"ŒöŒ±œÑŒ¨œÉœÑŒ±œÉŒ∑", ready:"ŒïœÑŒøŒπŒºœåœÑŒ∑œÑŒ±", shipped:"ŒëœÄŒøœÉœÑŒøŒªŒÆ", total:"Œ£œçŒΩŒøŒªŒø", progress:"Œ†œÅœåŒøŒ¥ŒøœÇ", details:"ŒõŒµœÄœÑŒøŒºŒ≠œÅŒµŒπŒµœÇ", noOrders:"ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ", pending:"Œ£Œµ Œ±ŒΩŒ±ŒºŒøŒΩŒÆ", production:"Œ£Œµ œÄŒ±œÅŒ±Œ≥œâŒ≥ŒÆ", readyStatus:"ŒàœÑŒøŒπŒºŒø", shippedStatus:"ŒëœÄŒµœÉœÑŒ¨ŒªŒ∑", back:"Œ†ŒØœÉœâ", manager:"ŒîŒπŒ±œáŒµŒπœÅŒπœÉœÑŒÆœÇ", prepaid:"Œ†œÅŒøœÄŒªŒ∑œÅœâŒºŒÆ", balance:"Œ•œÄœåŒªŒøŒπœÄŒø", plan:"Œ†ŒªŒ¨ŒΩŒø", fact:"Œ†œÅŒ±Œ≥ŒºŒ±œÑŒπŒ∫œå", error:"ŒõŒ¨Œ∏ŒøœÇ", daysInProd:"ŒóŒºŒ≠œÅŒµœÇ", items:"Œ†œÅŒøœäœåŒΩœÑŒ±", product:"Œ†œÅŒøœäœåŒΩ", qty:"Œ†ŒøœÉ.", itemStatus:"ŒöŒ±œÑŒ¨œÉœÑŒ±œÉŒ∑", reserved:"ŒîŒµœÉŒºŒµœÖŒºŒ≠ŒΩŒø", toProduce:"Œ†œÅŒøœÇ œÄŒ±œÅŒ±Œ≥œâŒ≥ŒÆ", shipments:"ŒôœÉœÑŒøœÅŒπŒ∫œå ŒëœÄŒøœÉœÑŒøŒªœéŒΩ", noShipments:"ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ", totalShipped:"Œ£œçŒΩŒøŒªŒø Œ±œÄŒøœÉœÑŒøŒªœéŒΩ" },
    nl: { welcome:"Stella Portaal", login:"Inloggen", dealerCode:"Code", password:"Wachtwoord", myOrders:"Bestellingen", logout:"Uitloggen", orderNo:"Nr.", date:"Datum", status:"Status", ready:"Gereed", shipped:"Verzending", total:"Totaal", progress:"Voortgang", details:"Details", noOrders:"Geen bestellingen", pending:"In wachtrij", production:"In productie", readyStatus:"Gereed", shippedStatus:"Verzonden", back:"Terug", manager:"Manager", prepaid:"Vooruitbetaald", balance:"Saldo", plan:"Plan", fact:"Werkelijk", error:"Ongeldig", daysInProd:"Dagen", items:"Artikelen", product:"Product", qty:"Aantal", itemStatus:"Status", reserved:"Gereserveerd", toProduce:"Te produceren", shipments:"Verzendgeschiedenis", noShipments:"Geen verzendingen", totalShipped:"Totaal verzonden" },
    hu: { welcome:"Stella Port√°l", login:"Bel√©p√©s", dealerCode:"K√≥d", password:"Jelsz√≥", myOrders:"Rendel√©seim", logout:"Kil√©p√©s", orderNo:"Sz√°m", date:"D√°tum", status:"St√°tusz", ready:"K√©sz", shipped:"Sz√°ll√≠t√°s", total:"√ñsszesen", progress:"Folyamat", details:"R√©szletek", noOrders:"Nincs rendel√©s", pending:"V√°rakozik", production:"Gy√°rt√°sban", readyStatus:"K√©sz", shippedStatus:"Kisz√°ll√≠tva", back:"Vissza", manager:"Menedzser", prepaid:"El≈ëleg", balance:"Egyenleg", plan:"Terv", fact:"T√©nyleges", error:"Hib√°s", daysInProd:"Nap", items:"T√©telek", product:"Term√©k", qty:"Db", itemStatus:"St√°tusz", reserved:"Foglalt", toProduce:"Gy√°rtand√≥", shipments:"Sz√°ll√≠t√°si el≈ëzm√©nyek", noShipments:"Nincs sz√°ll√≠t√°s", totalShipped:"√ñsszes sz√°ll√≠tva" },
    ru: { welcome:"–ü–æ—Ä—Ç–∞–ª –¥–∏–ª–µ—Ä–æ–≤ Stella", login:"–í—Ö–æ–¥", dealerCode:"–ö–æ–¥ –¥–∏–ª–µ—Ä–∞", password:"–ü–∞—Ä–æ–ª—å", myOrders:"–ú–æ–∏ –∑–∞–∫–∞–∑—ã", logout:"–í—ã—Ö–æ–¥", orderNo:"‚Ññ –∑–∞–∫–∞–∑–∞", date:"–î–∞—Ç–∞", status:"–°—Ç–∞—Ç—É—Å", ready:"–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å", shipped:"–û—Ç–≥—Ä—É–∑–∫–∞", total:"–°—É–º–º–∞", progress:"–ü—Ä–æ–≥—Ä–µ—Å—Å", details:"–ü–æ–¥—Ä–æ–±–Ω–µ–µ", noOrders:"–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", pending:"–í –æ—á–µ—Ä–µ–¥–∏", production:"–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ", readyStatus:"–ì–æ—Ç–æ–≤", shippedStatus:"–û—Ç–≥—Ä—É–∂–µ–Ω", back:"–ù–∞–∑–∞–¥", manager:"–ú–µ–Ω–µ–¥–∂–µ—Ä", prepaid:"–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞", balance:"–û—Å—Ç–∞—Ç–æ–∫", plan:"–ü–ª–∞–Ω", fact:"–§–∞–∫—Ç", error:"–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", daysInProd:"–î–Ω–µ–π", items:"–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞", product:"–¢–æ–≤–∞—Ä", qty:"–ö–æ–ª-–≤–æ", itemStatus:"–°—Ç–∞—Ç—É—Å", reserved:"–í —Ä–µ–∑–µ—Ä–≤–µ", toProduce:"–ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É", shipments:"–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≥—Ä—É–∑–æ–∫", noShipments:"–û—Ç–≥—Ä—É–∑–æ–∫ –Ω–µ—Ç", totalShipped:"–í—Å–µ–≥–æ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ" },
    es: { welcome:"Portal Stella", login:"Entrar", dealerCode:"C√≥digo", password:"Contrase√±a", myOrders:"Mis pedidos", logout:"Salir", orderNo:"Pedido", date:"Fecha", status:"Estado", ready:"Fecha listo", shipped:"Env√≠o", total:"Total", progress:"Progreso", details:"Detalles", noOrders:"Sin pedidos", pending:"En cola", production:"En producci√≥n", readyStatus:"Listo", shippedStatus:"Enviado", back:"Volver", manager:"Gerente", prepaid:"Prepago", balance:"Saldo", plan:"Plan", fact:"Real", error:"Inv√°lido", daysInProd:"D√≠as", items:"Art√≠culos", product:"Producto", qty:"Cant.", itemStatus:"Estado", reserved:"Reservado", toProduce:"A producir", shipments:"Historial de env√≠os", noShipments:"Sin env√≠os", totalShipped:"Total enviado" }
};

const FLAGS = { en:'üá¨üáß', de:'üá©üá™', it:'üáÆüáπ', tr:'üáπüá∑', el:'üá¨üá∑', nl:'üá≥üá±', hu:'üá≠üá∫', ru:'üá∑üá∫', es:'üá™üá∏' };

let DATA = { orders: [], orderItems: [], dealers: [], shipments: [], loaded: false, error: null };
let S = { page: 'login', lang: 'en', user: null, selOrder: null, tab: 'orders' };

const t = k => T[S.lang]?.[k] || T.en[k] || k;
const fmt = n => '‚Ç¨' + parseFloat(n || 0).toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
const fmtDate = d => {
    if (!d) return '-';
    if (typeof d === 'string') {
        if (d.includes('T')) return d.split('T')[0];
        if (d.includes('-')) return d;
        // Handle dd.mm.yyyy format
        if (d.includes('.')) {
            const parts = d.split('.');
            if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
    }
    return d;
};

async function loadData() {
    const baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values`;
    
    try {
        const [ordersRes, itemsRes, dealersRes, shipmentsRes] = await Promise.all([
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.ORDERS)}?key=${CONFIG.API_KEY}`).then(r => r.json()),
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.ORDER_ITEMS)}?key=${CONFIG.API_KEY}`).then(r => r.json()),
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.DEALERS)}?key=${CONFIG.API_KEY}`).then(r => r.json()),
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.SHIPMENTS)}?key=${CONFIG.API_KEY}`).then(r => r.json()).catch(() => ({values: []}))
        ]);
        
        function parse(data) {
            if (!data.values || data.values.length < 2) return [];
            const headers = data.values[0].map(h => h.toString().toLowerCase().replace(/[^a-z0-9]/g, '_'));
            return data.values.slice(1).map(row => {
                const obj = {};
                headers.forEach((h, i) => obj[h] = row[i] || '');
                return obj;
            });
        }
        
        DATA.orders = parse(ordersRes);
        DATA.orderItems = parse(itemsRes);
        DATA.dealers = parse(dealersRes);
        DATA.shipments = parse(shipmentsRes);
        DATA.loaded = true;
        
        console.log('‚úÖ Data loaded:', DATA);
        render();
        
    } catch (err) {
        console.error('‚ùå Error:', err);
        DATA.error = err.message;
        render();
    }
}

function render() {
    const app = document.getElementById('app');
    if (!DATA.loaded && !DATA.error) return;
    if (DATA.error) { app.innerHTML = errorPage(); return; }
    if (S.page === 'login') app.innerHTML = loginPage();
    else if (S.page === 'main') app.innerHTML = layout(mainContent());
    else if (S.page === 'detail') app.innerHTML = layout(detailPage());
    bind();
}

function errorPage() {
    return `<div class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
            <div class="text-6xl mb-4">‚ùå</div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Connection Error</h2>
            <p class="text-gray-500 mb-4">${DATA.error}</p>
            <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Retry</button>
        </div>
    </div>`;
}

function loginPage() {
    return `<div class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="flex justify-center flex-wrap gap-2 mb-6">
                ${Object.keys(FLAGS).map(l=>`<button onclick="setLang('${l}')" class="w-9 h-9 rounded-full ${S.lang===l?'ring-2 ring-blue-500':''} text-xl hover:scale-110 transition">${FLAGS[l]}</button>`).join('')}
            </div>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">STELLA</h1>
                <p class="text-gray-500">${t('welcome')}</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('dealerCode')}</label>
                    <input type="text" id="code" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="" autofocus>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('password')}</label>
                    <input type="password" id="pass" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="err" class="hidden text-red-500 text-sm text-center"></div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">${t('login')}</button>
            </form>
        </div>
    </div>`;
}

function layout(content) {
    return `<div class="min-h-screen bg-gray-50">
        <header class="gradient-bg text-white">
            <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-bold">STELLA</h1>
                    <span class="text-blue-200">|</span>
                    <span class="text-blue-100">${S.user?.company_name || S.user?.dealer_code}</span>
                </div>
                <div class="flex items-center gap-2">
                    ${Object.keys(FLAGS).map(l=>`<button onclick="setLang('${l}')" class="w-7 h-7 rounded ${S.lang===l?'bg-white/20':'hover:bg-white/10'} text-sm transition">${FLAGS[l]}</button>`).join('')}
                    <button onclick="logout()" class="ml-3 text-blue-100 hover:text-white text-sm">${t('logout')}</button>
                </div>
            </div>
        </header>
        <main class="max-w-6xl mx-auto px-4 py-8">${content}</main>
    </div>`;
}

function mainContent() {
    const ordersCount = DATA.orders.filter(o => o.dealer_code === S.user?.dealer_code).length;
    const shipmentsCount = DATA.shipments.filter(s => s.dealer_code === S.user?.dealer_code).length;
    
    return `
    <div class="flex border-b mb-6">
        <button onclick="setTab('orders')" class="px-6 py-3 ${S.tab === 'orders' ? 'tab-active' : 'tab-inactive'}">
            üì¶ ${t('myOrders')} (${ordersCount})
        </button>
        <button onclick="setTab('shipments')" class="px-6 py-3 ${S.tab === 'shipments' ? 'tab-active' : 'tab-inactive'}">
            üöö ${t('shipments')} (${shipmentsCount})
        </button>
    </div>
    ${S.tab === 'orders' ? ordersPage() : shipmentsPage()}`;
}

function ordersPage() {
    const orders = DATA.orders
        .filter(o => o.dealer_code === S.user?.dealer_code)
        .sort((a, b) => {
            const dateA = new Date(a.order_date || 0);
            const dateB = new Date(b.order_date || 0);
            return dateB - dateA;
        });
    if (!orders.length) return `<div class="bg-white rounded-xl p-12 text-center text-gray-500">${t('noOrders')}</div>`;
    
    return `<div class="space-y-4">${orders.map(o => orderCard(o)).join('')}</div>`;
}

function shipmentsPage() {
    const shipments = DATA.shipments
        .filter(s => s.dealer_code === S.user?.dealer_code)
        .sort((a, b) => {
            const dateA = new Date(fmtDate(a.order_date) || 0);
            const dateB = new Date(fmtDate(b.order_date) || 0);
            return dateB - dateA;
        });
    
    if (!shipments.length) return `<div class="bg-white rounded-xl p-12 text-center text-gray-500">${t('noShipments')}</div>`;
    
    // Group by order
    const byOrder = {};
    let totalEur = 0;
    shipments.forEach(s => {
        if (!byOrder[s.order_id]) byOrder[s.order_id] = { date: s.order_date, items: [], total: 0 };
        byOrder[s.order_id].items.push(s);
        const amt = parseFloat(s.amount_eur) || 0;
        byOrder[s.order_id].total += amt;
        totalEur += amt;
    });
    
    return `
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center">
            <h3 class="font-semibold">${t('totalShipped')}</h3>
            <span class="text-2xl font-bold text-green-600">${fmt(totalEur)}</span>
        </div>
    </div>
    
    <div class="space-y-4">
        ${Object.entries(byOrder).map(([orderId, data]) => `
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center cursor-pointer" onclick="toggleShipment('${orderId}')">
                <div>
                    <span class="font-semibold">${orderId}</span>
                    <span class="text-gray-500 text-sm ml-2">${fmtDate(data.date)}</span>
                    <span class="text-gray-400 text-sm ml-2">(${data.items.length} items)</span>
                </div>
                <span class="font-semibold text-green-600">${fmt(data.total)}</span>
            </div>
            <div id="ship-${orderId}" class="hidden">
                <table class="w-full">
                    <thead>
                        <tr class="border-b bg-gray-50">
                            <th class="text-left py-2 px-4 text-sm font-medium text-gray-500">${t('product')}</th>
                            <th class="text-right py-2 px-4 text-sm font-medium text-gray-500">${t('total')} (EUR)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.items.map(item => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4 text-sm">${item.product}</td>
                            <td class="py-2 px-4 text-sm text-right font-medium">${fmt(item.amount_eur)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>`).join('')}
    </div>`;
}

function orderCard(o) {
    const statusCls = s => {
        s = (s||'').toLowerCase();
        if (s.includes('production') || s.includes('–ø—Ä–æ–∏–∑–≤–æ–¥')) return 'status-production';
        if (s.includes('ready') || s.includes('–≥–æ—Ç–æ–≤')) return 'status-ready';
        if (s.includes('shipped') || s.includes('–æ—Ç–≥—Ä—É–∂')) return 'status-shipped';
        return 'status-pending';
    };
    const statusTxt = s => {
        s = (s||'').toLowerCase();
        if (s.includes('production') || s.includes('–ø—Ä–æ–∏–∑–≤–æ–¥')) return t('production');
        if (s.includes('ready') || s.includes('–≥–æ—Ç–æ–≤')) return t('readyStatus');
        if (s.includes('shipped') || s.includes('–æ—Ç–≥—Ä—É–∂')) return t('shippedStatus');
        return t('pending');
    };
    
    let progress = 0;
    if (o.progress__) {
        const match = o.progress__.toString().replace(',', '.').match(/[\d.]+/);
        if (match) progress = parseFloat(match[0]);
    }
    
    const itemCount = DATA.orderItems.filter(i => i.order_id === o.order_id).length;
    
    return `<div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition cursor-pointer" onclick="viewOrder('${o.order_id}')">
        <div class="flex justify-between items-start mb-4">
            <div>
                <p class="font-semibold text-lg">${o.order_id}</p>
                <p class="text-sm text-gray-500">${fmtDate(o.order_date)} ‚Ä¢ ${itemCount} ${t('items').toLowerCase()}</p>
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-medium ${statusCls(o.status)}">${statusTxt(o.status)}</span>
        </div>
        <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-500">${t('progress')}</span>
                <span class="font-medium">${progress}%</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
        </div>
        <div class="grid grid-cols-3 gap-4 text-sm">
            <div><p class="text-gray-500">${t('ready')} (${t('plan')})</p><p class="font-medium">${fmtDate(o.ready_date_plan)}</p></div>
            <div><p class="text-gray-500">${t('shipped')} (${t('plan')})</p><p class="font-medium">${fmtDate(o.ship_date_plan)}</p></div>
            <div class="text-right"><p class="text-gray-500">${t('total')}</p><p class="font-semibold text-blue-600">${fmt(o.total_eur)}</p></div>
        </div>
    </div>`;
}

function detailPage() {
    const o = DATA.orders.find(x => x.order_id === S.selOrder);
    if (!o) { S.page = 'main'; render(); return ''; }
    
    const items = DATA.orderItems.filter(i => i.order_id === S.selOrder);
    
    const statusCls = s => {
        s = (s||'').toLowerCase();
        if (s.includes('production') || s.includes('–ø—Ä–æ–∏–∑–≤–æ–¥')) return 'status-production';
        if (s.includes('ready') || s.includes('–≥–æ—Ç–æ–≤')) return 'status-ready';
        if (s.includes('shipped') || s.includes('–æ—Ç–≥—Ä—É–∂')) return 'status-shipped';
        return 'status-pending';
    };
    const statusTxt = s => {
        s = (s||'').toLowerCase();
        if (s.includes('production') || s.includes('–ø—Ä–æ–∏–∑–≤–æ–¥')) return t('production');
        if (s.includes('ready') || s.includes('–≥–æ—Ç–æ–≤')) return t('readyStatus');
        if (s.includes('shipped') || s.includes('–æ—Ç–≥—Ä—É–∂')) return t('shippedStatus');
        return t('pending');
    };
    
    const itemStatusCls = s => {
        s = (s||'').toLowerCase();
        if (s.includes('reserved') || s.includes('—Ä–µ–∑–µ—Ä–≤')) return 'item-reserved';
        if (s.includes('produce') || s.includes('–æ–±–µ—Å–ø–µ—á')) return 'item-toproduce';
        if (s.includes('shipped') || s.includes('–æ—Ç–≥—Ä—É–∂')) return 'item-shipped';
        return 'bg-gray-100 text-gray-600';
    };
    const itemStatusTxt = s => {
        s = (s||'').toLowerCase();
        if (s.includes('reserved') || s.includes('—Ä–µ–∑–µ—Ä–≤')) return t('reserved');
        if (s.includes('produce') || s.includes('–æ–±–µ—Å–ø–µ—á')) return t('toProduce');
        if (s.includes('shipped') || s.includes('–æ—Ç–≥—Ä—É–∂')) return t('shippedStatus');
        return s;
    };
    
    let progress = 0;
    if (o.progress__) {
        const match = o.progress__.toString().replace(',', '.').match(/[\d.]+/);
        if (match) progress = parseFloat(match[0]);
    }
    
    return `
    <button onclick="S.page='main';render()" class="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-6">‚Üê ${t('back')}</button>
    
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 class="text-2xl font-bold">${o.order_id}</h2>
                <p class="text-gray-500">${o.dealer_name}</p>
            </div>
            <span class="px-4 py-2 rounded-full text-sm font-medium ${statusCls(o.status)}">${statusTxt(o.status)}</span>
        </div>
        
        <div class="mb-6">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-500">${t('progress')}</span>
                <span class="font-bold text-lg">${progress}%</span>
            </div>
            <div class="progress-bar h-3"><div class="progress-fill" style="width: ${progress}%"></div></div>
            ${o.days_in_production ? `<p class="text-sm text-gray-500 mt-2">${t('daysInProd')}: ${o.days_in_production}</p>` : ''}
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500">${t('date')}</p>
                <p class="font-medium">${fmtDate(o.order_date)}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500">${t('ready')} (${t('plan')})</p>
                <p class="font-medium">${fmtDate(o.ready_date_plan)}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500">${t('ready')} (${t('fact')})</p>
                <p class="font-medium ${o.ready_date_fact ? 'text-green-600' : ''}">${fmtDate(o.ready_date_fact)}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500">${t('shipped')} (${t('plan')})</p>
                <p class="font-medium">${fmtDate(o.ship_date_plan)}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <h3 class="font-semibold mb-4">üí∞ ${t('total')}</h3>
        <div class="grid grid-cols-3 gap-4">
            <div class="p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-500">${t('total')}</p>
                <p class="text-xl font-bold text-blue-600">${fmt(o.total_eur)}</p>
            </div>
            <div class="p-4 bg-green-50 rounded-lg">
                <p class="text-sm text-gray-500">${t('prepaid')}</p>
                <p class="text-xl font-bold text-green-600">${fmt(o.prepaid_eur)}</p>
            </div>
            <div class="p-4 bg-orange-50 rounded-lg">
                <p class="text-sm text-gray-500">${t('balance')}</p>
                <p class="text-xl font-bold text-orange-600">${fmt(o.balance_eur)}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="font-semibold mb-4">üì¶ ${t('items')} (${items.length})</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-3 px-2 text-sm font-medium text-gray-500">#</th>
                        <th class="text-left py-3 px-2 text-sm font-medium text-gray-500">${t('product')}</th>
                        <th class="text-center py-3 px-2 text-sm font-medium text-gray-500">${t('itemStatus')}</th>
                        <th class="text-right py-3 px-2 text-sm font-medium text-gray-500">${t('qty')}</th>
                        <th class="text-right py-3 px-2 text-sm font-medium text-gray-500">${t('total')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map((item, idx) => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-2 text-sm text-gray-400">${item.line || idx + 1}</td>
                        <td class="py-3 px-2">
                            <p class="font-medium text-sm">${item.product_name}</p>
                        </td>
                        <td class="py-3 px-2 text-center">
                            <span class="px-2 py-1 rounded text-xs font-medium ${itemStatusCls(item.item_status)}">${itemStatusTxt(item.item_status)}</span>
                        </td>
                        <td class="py-3 px-2 text-right font-medium">${item.quantity}</td>
                        <td class="py-3 px-2 text-right font-medium">${fmt(item.total_eur)}</td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>
    
    ${o.manager ? `<div class="mt-6 text-sm text-gray-500">${t('manager')}: ${o.manager}</div>` : ''}`;
}

function setLang(l) { S.lang = l; render(); }
function setTab(tab) { S.tab = tab; render(); }
function logout() { S = { page: 'login', lang: S.lang, user: null, selOrder: null, tab: 'orders' }; render(); }
function viewOrder(id) { S.selOrder = id; S.page = 'detail'; render(); }
function toggleShipment(id) {
    const el = document.getElementById('ship-' + id);
    if (el) el.classList.toggle('hidden');
}

function bind() {
    const form = document.getElementById('loginForm');
    if (form) {
        form.onsubmit = e => {
            e.preventDefault();
            const code = document.getElementById('code').value.toUpperCase().trim();
            const pass = document.getElementById('pass').value;
            
            // Individual passwords for each dealer
            const PASSWORDS = {
                'HEXIM': 'Hexim#2025',
                'PURE': 'Pure#2025',
                'DECORATION': 'Decor#2025',
                'DECOALA': 'Deco#2025',
                'NEWPLAN': 'Newplan#2025',
                'MEGAHOME': 'Mega#2025',
                'HOGARDECOR': 'Hogar#2025',
                'MARS': 'Mars#2025',
                'NASAEV': 'Nasaev#2025',
                'CAPSULA': 'Capsula#2025',
                'ADMIN': 'StellaAdmin#2025'
            };
            
            const dealerOrders = DATA.orders.filter(o => o.dealer_code === code);
            const dealerShipments = DATA.shipments.filter(s => s.dealer_code === code);
            const dealer = DATA.dealers.find(d => d.dealer_code === code);
            
            const validPassword = PASSWORDS[code] === pass;
            
            if ((dealerOrders.length > 0 || dealerShipments.length > 0 || dealer) && validPassword) {
                S.user = dealer || { dealer_code: code, company_name: dealerOrders[0]?.dealer_name || dealerShipments[0]?.dealer_name || code };
                S.lang = dealer?.language || 'en';
                S.page = 'main';
                S.tab = 'orders';
                render();
            } else {
                document.getElementById('err').textContent = t('error');
                document.getElementById('err').classList.remove('hidden');
            }
        };
    }
}

// Initial load
loadData();

// Auto-refresh every 15 minutes
setInterval(() => {
    console.log('üîÑ Auto-refreshing data...');
    loadData();
}, 900000);
    </script>
</body>
</html>
